---
title: "R Notebook"
output: html_notebook
---
```{r include=FALSE}
library(tidyverse)
library(dplyr)

source("metrics.r")
source("common.r")
source("experiment_data.r")

## Loading in the data
data_groupsizb <- loadGroupSizeBoundsExperimentData("gsc_exp_final1")

```

These are some other plots

```{r eval=FALSE, include=FALSE, fig.width=13}


make_title <- function(mechanism_name, proj_pref_type) {
    pretty_mechanism_name = mechanism_name_map[[mechanism_name]]
    pretty_proj_pref_type = paste("(", proj_pref_type, ")", sep = "")
    paste(pretty_mechanism_name, pretty_proj_pref_type, sep = " - ")
}


# RUNTIMES
# for (ppt in levels(data_groupsizb$proj_pref_type)) {
    # for (mech in levels(data_groupsizb$mechanism)) {
        
        data_filtered <- data_groupsizb %>% filter(mechanism == mech)
        
        pretty_title = make_title(mech, "all")
        # worst_runtime <- sort(data_filtered$duration_ms, decreasing = TRUE)[4] / 1000
        
        plot <- ggplot(data_groupsizb %>% filter(num_students != 50),
                       aes(x = factor(num_students),
                           y = ceiling(duration_ms / 1000),
                           group = interaction(mechanism, num_students),
                           color = mechanism_short)
                    ) +
                    geom_boxplot() +
                    facet_grid(gsc_max ~ gsc_min,
                               labeller = labeller(gsc_max = ~ paste("u:", .),
                                                   gsc_min = ~ paste("l:", .))
                               ) +
                    # ylim(0, worst_runtime) + 
                    scale_y_continuous(trans = "log10", oob = scales::oob_squish_any,
                                       labels = \(z) scales::label_math(expr = 10^.x)(log10(z))
                                       ) + 
                    scale_x_discrete() +
                    labs(
                        title = "Group size bounds scaling - runtime",
                        y = "Duration (sec)",
                        x = "# students"
                    ) +
                    theme(legend.position = "bottom", legend.direction = "horizontal")
        
        print(plot)
        
        path = paste("plots", "groupsizes_exp", "runtimes", ppt, sep = "/")
        filename <- paste(path, paste("runtimes_", pretty_title, ".png", sep = ""), sep ="/")
        # ggsave(filename,
        #        device = "png", width = 120, height = 120, units = "mm", pointsize = 100
        # )
    # }
# }

        
# QUALITY (AUPCR)
for (ppt in levels(data_groupsizb$proj_pref_type)){
    for (mech in levels(data_groupsizb$mechanism)) {
        
        data_filtered <- data_groupsizb %>% filter(trial == 0 & mechanism == mech & proj_pref_type == ppt)
        
        pretty_title = make_title(mech, ppt)
        
        plot <- ggplot(data_filtered, aes(x = num_students, y = aupcr, group = num_students)) +
                    geom_boxplot() +
                    # geom_jitter(position=position_jitter(0.2)) +
                    facet_grid(gsc_max ~ gsc_min,
                               labeller = labeller(gsc_max = ~ paste("u:", .),
                                                   gsc_min = ~ paste("l:", .))
                               ) +
                    ylim(0.5, 1) + 
                    labs(
                        title = make_title(mech, ppt),
                        y = "AUPCR",
                        x = "# students"
                    )
        
        print(plot)
        
        path = paste("plots", "groupsizes_exp", "aupcr", ppt, sep = "/")
        filename <- paste(path, paste("aupcr_", pretty_title, ".png", sep = ""), sep ="/")
        ggsave(filename,
               device = "png", width = 120, height = 120, units = "mm", pointsize = 100
        )
    }
}
```
