---
title: "R Notebook"
output: html_notebook
---
```{r include=FALSE}
library(tidyverse)
library(dplyr)

source('metrics.r')

## Loading in the data
exp_name = "gsc_exp_att1"

data_dir = "D:\\Code\\Git repositories\\aidm-optimal-groups\\results\\thesis"

exp_files <- list.files(data_dir, pattern = paste0(exp_name, "_.*\\.csv"), full.names = TRUE)

column_spec <- cols_only(
    num_students = col_integer(),
    num_projects = col_integer(),
    num_slots = col_factor(),
    proj_pref_type = col_factor(),
    pregroup_type = col_factor(),
    mechanism = col_factor(),
    trial = col_factor(),
    duration_ms = col_integer(),
    profile_all = col_character(),
    project_pressure = col_factor(),
    gsc_min = col_integer(),
    gsc_max = col_integer()
)


data_exps <- map_dfr(exp_files, read_csv, col_types = column_spec)
data_exps_aug <- data_exps %>%
    mutate(
        worst_rank = map(profile_all, worst_obtained_rank) %>% unlist,
        aupcr = map2(num_projects, profile_all, calc_aupcr) %>% unlist
    )

mechanism_name_map = new.env()
mechanism_name_map[["Chiarandini w Fair pregrouping owa - no_grouping"]] = "Fair"
mechanism_name_map[["BepSys (reworked) - Borda"]] = "BEPSys"
mechanism_name_map[["Chiaranini MiniMax-OWA - no_grouping"]] = "Chiarandini"

data_all <- data_exps_aug

```

These are some other plots

```{r eval=FALSE, include=FALSE}


title <- function(mechanism_name, proj_pref_type) {
    pretty_mechanism_name = mechanism_name_map[[mechanism_name]]
    pretty_proj_pref_type = paste("(", proj_pref_type, ")", sep = "")
    paste(pretty_mechanism_name, pretty_proj_pref_type, sep = " - ")
}


# RUNTIMES
for (ppt in levels(data_all$proj_pref_type)){
    for (mech in levels(data_all$mechanism)) {
        
        data_filtered <- data_all %>% filter(mechanism == mech & proj_pref_type == ppt)
        
        pretty_title = title(mech, ppt)
        
        plot <- ggplot(data_filtered, aes(x = num_students, y = duration_ms / 1000, group = num_students)) +
                    geom_boxplot() +
                    # geom_jitter(position=position_jitter(0.2)) +
                    facet_grid(gsc_max ~ gsc_min) +
                    ylim(0, 90) + 
                    labs(
                        title = title(mech, ppt),
                        y = "Duration (sec)",
                        x = "# students"
                    )
        
        print(plot)
        
        path = paste("plots", "groupsizes_exp", "runtimes", ppt, sep = "/")
        filename <- paste(path, paste("runtimes_", pretty_title, ".png", sep = ""), sep ="/")
        ggsave(filename,
               device = "png", width = 120, height = 120, units = "mm", pointsize = 100
        )
    }
}

# QUALITY (AUPCR)
for (ppt in levels(data_all$proj_pref_type)){
    for (mech in levels(data_all$mechanism)) {
        
        data_filtered <- data_all %>% filter(trial == 0 & mechanism == mech & proj_pref_type == ppt)
        
        pretty_title = title(mech, ppt)
        
        plot <- ggplot(data_filtered, aes(x = num_students, y = aupcr, group = num_students)) +
                    geom_boxplot() +
                    # geom_jitter(position=position_jitter(0.2)) +
                    facet_grid(gsc_max ~ gsc_min) +
                    ylim(0.5, 1) + 
                    labs(
                        title = title(mech, ppt),
                        y = "AUPCR",
                        x = "# students"
                    )
        
        print(plot)
        
        path = paste("plots", "groupsizes_exp", "aupcr", ppt, sep = "/")
        filename <- paste(path, paste("aupcr_", pretty_title, ".png", sep = ""), sep ="/")
        ggsave(filename,
               device = "png", width = 120, height = 120, units = "mm", pointsize = 100
        )
    }
}
```

## Using plotly
```{r}

library(plotly)

plot_data <- function(data) {
    fig <- plot_ly(data,
            x = ~num_projects,
            y = ~num_students,
            z = ~(duration_ms / 1000),
            color = ~as.factor(mechanism),
            colors = colors_mechanism
        ) %>%
        add_markers(size=1) %>% 
        layout(
            scene = list(
                xaxis = list(title = "# projects"),
                yaxis = list(title = "# students"),
                zaxis = list(title = "duration (sec)", type = "log"),
                camera = list(projection = list(type = 'orthographic'))
            ),
            legend = list(orientation = "h")
        )
    
    return(fig)
}

plot_data(data_all)
plot_data(data_singleton)
plot_data(data_p1)
plot_data(data_p4)
plot_data(data_r)
```

