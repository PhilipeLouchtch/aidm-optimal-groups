```{r echo=FALSE, render=FLASE}
library(tidyverse)
library(ggh4x)
library(ggbeeswarm)

source("experiment_data.r")
source("metrics.r")
```


# Any vs Except vs Max-only pregrouping settings comparisons
```{r fig.height = 8}
# Taken from the 12 color scheme at http://tsitsul.in/blog/coloropt/
palette_11 <- c('#b80058', '#ebac23', '#008cf9',
                '#00bbad', '#006e00', '#d163e6',
                '#b24502', '#ff9287', '#5954d6',
                '#00c6f8', '#878500', '#00a76c')

color_scale_ce <- function() {
    mapping <- setNames(palette_11, levels(data$edition))
    print(mapping)
    ggplot2::scale_color_manual(values = mapping, limits = force)
}

data <- read_csv("C:\\WORK\\thesis\\aidm-optimal-groups\\reports\\anyexcept_tud.csv", show_col_types = FALSE) |> 
    mutate(
        edition = factor(edition, ordered = T,
                         levels = c("CE3","CE4","CE10","CE11","CE14","CE17","CE18","CE23","CE39","CE42","CE45")
                  ),
    )



plot_raupcr_for_editions <- function(editions) {
    
    if (is.null(editions)) {
        editions <- unique(data$edition)
    }

    data_longer <- data |>
        
        filter(edition %in% editions) |> 
        
        pivot_longer(
            cols = starts_with("profile_"),
            names_pattern = "profile_(.+)_(.+)",
            names_to = c("grouping_class", "satisfaction"),
            values_to = "profile"
        ) |>
        
        mutate(
            across(contains(c("together", "count")), \(x) (NULL)),
            
            worst_rank = profile |> map(worst_obtained_rank) |> unlist(),
            
            grouping_class = factor(grouping_class, ordered = T,
                                    levels = c("solo", "max", "small", "submax"),
                                    labels = c("'Solo' students",
                                               "'Maximal pregroups' students",
                                               "'Small pregroups' students",
                                               "'Submax pregroups' students")
                             ),
            
            scenario = factor(scenario, ordered = T,
                              levels = c("MAX", "EXCEPT", "ANY")
                       ),
            
            satisfaction = factor(satisfaction, ordered = T,
                       levels = c("sat", "unsat"),
                       labels = c("together", "not together"))
        ) |>
        
        # CE, max/small/submax, sat/unsat
        group_by( edition ) |>
        
            # worst rank within the grouping for the relative part of 'relative'-AUPCR
            mutate( worst_rank__grp = max(worst_rank) ) |>
        
        ungroup() |>
        
        # calc relative-AUPCR (max-rank is the "worst rank within grouping")
        # if the grouping is empty (then set AUPCR to 1 - this only makes sense for unsat group)
        mutate(
            r_aupcr = map2( worst_rank__grp, profile, ~ ifelse(is.na(.y), NA, calc_aupcr(.x, 0, .y)) ) |> unlist() # 
        )

    p_raupcr <- ggplot(data_longer,
            aes(x = interaction(mechanism, scenario),
                y = r_aupcr,
                group = interaction(scenario, mechanism)
            )
        ) +
        
        geom_boxplot(
            outlier.shape = NA, # hide outliers due to adding dots via geom_jitter
            alpha = 0,
            color = "#00000020"
        ) +
        
        # geom_violin(
        #     scale = "count"
        # ) +
        geom_beeswarm(
            mapping	= aes(color = edition),
            varwidth = TRUE,
            cex = 2,
            method = "center",
            priority = "none"
        ) +
        #rows = vars(satisfaction)
        facet_grid(cols = vars(grouping_class)) +
        color_scale_ce() +
        
        guides(x = "axis_nested") +
        
        labs(x = "Mechanism x Scenario combination",
             y = "relative-AUPCR",
             color = "Course edition"
        )
    
    # plot(p_raupcr)
    return(p_raupcr)
}

# Editions with all classes of pregroupings -> small, submax and max
plot_all_classes <- plot_raupcr_for_editions(c("CE4", "CE10", "CE11", "CE18"))
ggsave(plot = plot_all_classes,
       filename = "plots/thesis/historical_anyexceptmax_raupcr_ALL_CLASSES-groupingcombined.png",
       device = "png", width = 300, height = 90, units = "mm", dpi = "print"
)

plot_max_small <- plot_raupcr_for_editions(c("CE23", "CE39", "CE45"))
ggsave(plot = plot_max_small,
       filename = "plots/thesis/historical_anyexceptmax_raupcr_MAX_SMALL-groupingcombined.png",
       device = "png", width = 300, height = 90, units = "mm", dpi = "print"
)


plot_all <- plot_raupcr_for_editions(NULL)
ggsave(plot = plot_all,
       filename = "plots/thesis/historical_anyexceptmax_raupcr_o-groupingcombined.png",
       device = "png", width = 300, height = 160, units = "mm", dpi = "print"
)

```

Two questions:
    Is Any/Except a better scenario? Regardless of the mechanism (pick best)
    Is Fair better than Chia in the scenarios?l

More importantly, need to finish the viz for inclusion in the document. So:
   - rAUPCR must be tested
   - the AUPCR plots must be finalized, and:
   - the togetherness counts plotted to augment the AUPCR plots.


```{r fig.height = 8}
 # togetherness

data_togetherness <- data |>
    
    pivot_longer(
        cols = ends_with("_together") | ends_with("_count"),
        names_pattern = "(.+)_(.+)",
        names_to = c("grouping_class", "status"),
        values_to = "count"
    ) |>
    
    mutate(
        status = case_when(
            status == 'together' ~ 'together',
            status == 'count' ~ 'max'
        )
    ) |> 
    
    pivot_wider(
        names_from = status, values_from = count
    ) |> 
    
    select(edition, mechanism, scenario, grouping_class, together, max) |>
    
    mutate(
        proportion_sat = ifelse(max == 0, NA, together / max),
        # Don't plot "0 unsatisfied if all are together and handle case max = 0
        proportion_unsat = ifelse(together == max, NA, 1 - (together / max) ),
        together = NULL,
        max = NULL
    ) |> 
    
    pivot_longer(
        cols = starts_with("proportion"),
        names_to = "satisfaction",
        names_prefix = "proportion_",
        values_to = "proportion"
    ) |> 
    
    mutate(
        grouping_class = factor(grouping_class, ordered = TRUE,
                                levels = c("solo", "max", "small", "submax"),
                                labels = c("'Solo' students",
                                           "'Maximal pregroups' students",
                                           "'Small pregroups' students",
                                           "'Submax pregroups' students")
                         ),
        
        scenario = factor(scenario, ordered = TRUE,
                          levels = c("MAX", "EXCEPT", "ANY")
                   ),
        
        satisfaction = factor(satisfaction, ordered = T,
                              levels = c("sat", "unsat"),
                              labels = c("together", "not together")
                       )
    )

p_together <- ggplot(data_togetherness,
       aes(x = interaction(mechanism, scenario),
            y = proportion,
            group = interaction(scenario, mechanism)
        )
    ) +
    
    geom_boxplot(
        outlier.shape = NA, # hide outliers due to adding dots via geom_jitter
        alpha = 0,
        color = "#00000020"
    ) +
    
    # geom_violin(
    #     scale = "count"
    # ) +
    geom_beeswarm(
        mapping	= aes(color = edition),
        varwidth = TRUE,
        cex = 1.1,
        method = "center",
        priority = "none",
        corral = "wrap",
        corral.width = 0.1,
        groupOnX = T
        #position = position_jitterdodge(dodge.width = 0.8, jitter.width = 2)
    ) +
    
    facet_grid(rows = vars(satisfaction), cols = vars(grouping_class)) +
    color_scale_ce() +
    
    guides(x = "axis_nested") +
    
    labs(x = "Mechanism x Scenario combination",
         y = "Proportion students (not) together",
         color = "Course edition"
    )
    
print(p_together)
ggsave(plot = p_together,
       filename = "plots/thesis/historical_anyexceptmax_together.png",
       device = "png", width = 300, height = 160, units = "mm", dpi = "print"
)

```

   
   TODO: export png's and put into thesis.
   
   
## Testing the relative-AUPCR:


```{r}

scale_factors <- c(10, 3, 2.3)

# take the same profile
profile <- "3|0|2|2|0|0|1"
worst <- worst_obtained_rank(profile)

profile_parsed <- profile_histo(profile)
scaled_profile <- vector()

for (scale_factor in scale_factors) {
    
    scaled_profile <- profile_parsed * scale_factor
    scaled_profile[4] <- scaled_profile[4] + 1
    
    scaled_profile_serialized <- paste(scaled_profile, collapse  = "|")
    
    print(paste("Scale factor: ", scale_factor))
    
    print(paste("Base:     ", calc_aupcr(worst, 1, profile)))
    print(paste("Scaled   :", calc_aupcr(worst, 1, scaled_profile_serialized)))
    
    
    sum_base <- sum(profile_parsed)
    
    
    sum_scaled <- sum(scaled_profile)
    
    scaled_profile_add_norm_ser <- paste(scaled_profile / sum_scaled , collapse  = "|")
    profile_norm_ser <- paste(profile_parsed / sum_base, collapse = "|")
    
    
    print(paste("Base-norm:", calc_aupcr(worst, 1, profile_norm_ser)))
    print(paste("Scaled-nm:", calc_aupcr(worst, 1, scaled_profile_add_norm_ser)))
    
}


bbbbb <- "0.37037037037037|0|0.246913580246914|0.259259259259259|0|0|0.123456790123457"



```

Relative AUPCR results in the same value for all tested scalings of the profile. But what if the number of students change? Then tough luck?



## Project prefs generator viz for thesis

```{r}


prefs_data <- read_csv("C:\\WORK\\thesis\\aidm-optimal-groups\\results\\gen_prefs_export.csv", show_col_types = FALSE) |> 
    mutate(
        project = paste(pref_gen_name, num_students, project, sep = "_"),
        pref_gen_name = factor(pref_gen_name, ordered = T,
                               levels = c("singleton", "linear_perturbed_1", "linear_perturbed_4", "realistic", "random"),
                               labels = c("identical", "nearly identical", "mostly identical", "3-peaked", "Random")
                        ),
        num_students = factor(num_students, ordered = T,
                              levels = c(50, 200, 600),
                              labels = "50 students", "200 students", "600 students"
                       )
    )


p <- ggplot(prefs_data) +
    geom_violin(aes(
        x = with(prefs_data, reorder(project, rank, median)),
        y = rank
    ), color = "white", fill = "darkgreen") +
    
    facet_grid2(rows = vars(pref_gen_name), cols = vars(num_students),
               shrink = T, scales = "free", drop = T, independent = T) +
    
    # TODO: free space and constom x scale widths to improve the look of the plots
    force_panelsizes(cols = c(2, 3, 5)) +
    
    scale_x_discrete(labels = NULL, name = "Project") +
    scale_y_continuous(labels = NULL, name = "Rank")

print(p)

```